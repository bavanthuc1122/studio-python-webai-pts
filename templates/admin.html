<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Studio</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Chat message styles */
        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease-in;
        }
        
        .received-message {
            background: #f1f0f0;
            border-bottom-left-radius: 4px;
            align-self: flex-start;
        }
        
        .sent-message {
            background: #0084ff;
            color: white;
            border-bottom-right-radius: 4px;
            align-self: flex-end;
        }
        
        .message-time {
            font-size: 11px;
            margin-top: 5px;
            text-align: right;
        }
        
        .received-message .message-time {
            color: #65676b;
        }
        
        .sent-message .message-time {
            color: rgba(255, 255, 255, 0.8);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .chat-container {
                padding: 10px;
            }
            
            .message-bubble {
                max-width: 90%;
                padding: 10px 14px;
            }
            
            /* Mobile sidebar hidden by default */
            .sidebar.hidden-on-mobile {
                display: none;
            }
            
            /* Mobile detail view takes full width */
            .main-content.open {
                display: flex !important;
                flex-direction: column;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 1000;
            }
            
            /* Ensure chat area takes available space but allows footer to be visible */
            .chat-area {
                display: flex;
                flex-direction: column;
                height: 100%;
            }
            
            /* Chat header stays at top */
            .chat-header {
                flex-shrink: 0;
            }
            
            /* Chat container expands but scrolls */
            #chat-messages {
                flex: 1;
                overflow-y: auto;
                height: auto;
            }
            
            /* Chat footer stays at bottom */
            .chat-footer {
                flex-shrink: 0;
                position: relative !important;
                bottom: auto !important;
            }
        }
    </style>
</head>
<body>
    <div id="login-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:9999; display:flex; justify-content:center; align-items:center;">
        <div style="width:300px; text-align:center;">
            <h3>ƒêƒÉng nh·∫≠p H·ªá Th·ªëng</h3>
            <input type="text" id="u_name" placeholder="User" style="width:100%; padding:10px; margin-bottom:10px;">
            <input type="password" id="u_pass" placeholder="Pass" style="width:100%; padding:10px; margin-bottom:10px;">
            <button class="btn" onclick="login()">ƒêƒÉng nh·∫≠p</button>
        </div>
    </div>

    <div class="admin-container" id="dashboard" style="display:none;">
        
        <div class="sidebar">
            <div class="sidebar-header">Danh S√°ch KH (<span id="total-count">0</span>)</div>
            
            <div class="search-filter-row">
                <input type="text" id="search_box" placeholder="T√¨m ki·∫øm..." onkeyup="filterList()">
                <select id="filter_label" onchange="filterList()">
                    <option value="ALL">T·∫•t c·∫£</option>
                </select>
                <button onclick="openLabelMgr()" style="border:none; background:none; cursor:pointer;" title="Qu·∫£n l√Ω Label">‚öôÔ∏è</button>
                <button onclick="openConfigModal()" style="border:none; background:none; cursor:pointer;" title="C√†i ƒë·∫∑t">üé®</button>
                <button onclick="logout()" style="border:none; background:none; cursor:pointer; color:red;" title="ƒêƒÉng xu·∫•t">Exit</button>
            </div>

            <div class="msg-list" id="msg-list">
                <!-- Messages will be populated here -->
            </div>
        </div>

        <div class="main-content" id="detail-view-container">
            <div id="empty-state" style="margin: auto; color: #999;">Ch·ªçn m·ªôt h·ªôi tho·∫°i ƒë·ªÉ x·ª≠ l√Ω</div>
            
            <div id="detail-view" class="chat-area" style="display:none; flex-direction: column; height: 100%;">
                <!-- Header m·ªõi -->
                <div class="chat-header" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #eee; background: #f8f9fa; flex-shrink: 0;">
                    <button class="back-btn" onclick="closeDetail()" style="background: none; border: none; font-size: 18px; cursor: pointer;">‚Üê</button>
                    <div id="customer-name-header" style="font-weight: bold; flex: 1; text-align: center;">Th√∫y Nga</div>
                    <button onclick="deleteCurrentTicket()" style="background: none; border: none; color: #ff3b30; font-size: 16px; cursor: pointer;">üóë</button>
                </div>
                
                <!-- Group chat container -->
                <div class="chat-container" id="chat-messages" style="flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; height: auto;">
                    <!-- Messages will be added here by JavaScript -->
                </div>
                
                <!-- Sticky footer v·ªõi form v√† n√∫t l∆∞u -->
                <div class="chat-footer" style="background: white; padding: 15px; border-top: 1px solid #eee; flex-shrink: 0;">
                    <div style="margin-bottom: 15px;">
                        <select id="d_label" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px;" onchange="checkCompletion()">
                        </select>
                        
                        <textarea id="d_note" rows="2" placeholder="Nh·∫≠p ghi ch√∫..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; resize: vertical;"></textarea>
                        
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                            <span style="font-size: 14px; color: #666;">Link ·∫£nh:</span>
                            <a id="d_link_href" href="#" target="_blank" style="color: #0068ff; text-decoration: none; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Link</a>
                            <button onclick="copyLink()" style="background: #0068ff; color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 12px; cursor: pointer;">Sao ch√©p</button>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="saveChanges()" style="width: 100%; background: #28a745; color: white; border: none; border-radius: 8px; padding: 12px; font-weight: bold; cursor: pointer;">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>

    <div id="completionModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">üéâ G·ª≠i k·∫øt qu·∫£ cho kh√°ch</div>
            <p style="font-size:13px; color:#666; margin-bottom:10px;">Khi ch·ªçn "Ho√†n th√†nh", h√£y nh·∫≠p link ·∫£nh tr·∫£ v·ªÅ cho kh√°ch.</p>
            <label style="font-size:12px; font-weight:bold;">Link b·ªô ·∫£nh ho√†n thi·ªán</label>
            <input type="url" id="m_result_link" placeholder="https://drive.google.com/..." style="width:100%; padding:8px; margin-bottom:10px; border:1px solid #ddd; border-radius:4px;">
            <label style="font-size:12px; font-weight:bold;">L·ªùi nh·∫Øn g·ª≠i kh√°ch</label>
            <textarea id="m_result_msg" rows="3" placeholder="C·∫£m ∆°n b·∫°n ƒë√£ s·ª≠ d·ª•ng d·ªãch v·ª•..." style="width:100%; padding:8px; margin-bottom:20px; border:1px solid #ddd; border-radius:4px;"></textarea>
            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="confirmCompletion()" style="flex:1;">G·ª≠i & C·∫≠p nh·∫≠t</button>
                <button class="btn" onclick="closeModal('completionModal')" style="background:#ccc; flex:1;">H·ªßy</button>
            </div>
        </div>
    </div>

    <div id="labelMgrModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Qu·∫£n l√Ω Label</div>
            <div style="display:flex; gap:5px; margin-bottom:15px;">
                <input type="text" id="new_label_input" placeholder="T√™n Label m·ªõi..." style="flex:1; padding:8px;">
                <button onclick="manageLabelAPI('add')" style="padding:0 10px;">+</button>
            </div>
            <ul id="label-mgr-list" style="list-style:none; padding:0; max-height:200px; overflow-y:auto;"></ul>
            <button class="btn" onclick="closeModal('labelMgrModal')" style="background:#ccc; margin-top:10px;">ƒê√≥ng</button>
        </div>
    </div>

    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">üé® T√πy ch·ªânh Giao di·ªán Kh√°ch</div>
            <label style="font-size:12px; font-weight:bold;">Link ·∫¢nh N·ªÅn</label>
            <input type="url" id="cfg_bg" placeholder="https://..." style="width:100%; padding:8px; margin-bottom:15px; border:1px solid #ddd; border-radius:4px;">
            <label style="font-size:12px; font-weight:bold;">M√†u Ch·ªØ Ch√≠nh</label>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <input type="color" id="cfg_text" style="width:50px; height:40px; padding:0; border:none;">
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="saveConfig()">L∆∞u Thay ƒê·ªïi</button>
                <button class="btn" onclick="closeModal('configModal')" style="background:#ccc;">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <script>
        let allData = [], allLabels = [], currentRecord = null;
        const PUBLIC_LABELS = ["M·ªõi", "ƒê√£ x·ª≠ l√Ω", "Ch·ªù ph·∫£n h·ªìi", "Ho√†n th√†nh"];

        async function login() {
            const u = document.getElementById('u_name').value;
            const p = document.getElementById('u_pass').value;
            
            // Log th√¥ng tin ƒëƒÉng nh·∫≠p ƒë·ªÉ debug
            console.log("Login attempt:", {username: u, password: p});
            
            if (!u || !p) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n ƒëƒÉng nh·∫≠p v√† m·∫≠t kh·∫©u!');
                return;
            }
            
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            });
            const data = await res.json();
            console.log("Login response:", data);
            
            if(data.success) {
                localStorage.setItem("admin_token", "true"); 
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('dashboard').style.display = 'grid';
                loadData();
            } else {
                alert('Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!');
            }
        }

        function logout() {
            localStorage.removeItem("admin_token");
            window.location.reload();
        }

        async function loadData() {
            try {
                const res = await fetch('/api/admin/data');
                const d = await res.json();
                allData = d.messages || [];
                allLabels = d.labels || [];
                renderUI();
            } catch (error) {
                console.error("Error loading data:", error);
                alert("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.");
            }
        }

        function renderUI() {
            const opts = allLabels.map(l => `<option value="${l}">${l}</option>`).join('');
            document.getElementById('filter_label').innerHTML = '<option value="ALL">T·∫•t c·∫£</option>' + opts;
            document.getElementById('d_label').innerHTML = opts;
            
            // C·∫≠p nh·∫≠t t·ªïng s·ªë kh√°ch h√†ng
            document.getElementById('total-count').textContent = allData.length;
            
            filterList();
        }

        function filterList() {
            const txt = (document.getElementById('search_box').value || '').toLowerCase();
            const filter = document.getElementById('filter_label').value;
            const list = document.getElementById('msg-list');
            list.innerHTML = '';

            const filtered = allData.filter(i => {
                const matchTxt = (i.customer_name || '').toLowerCase().includes(txt) || (i.image_link || '').includes(txt);
                const matchLbl = filter === 'ALL' || i.label === filter;
                return matchTxt && matchLbl;
            });

            // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng kh√°ch h√†ng theo b·ªô l·ªçc
            document.getElementById('total-count').textContent = filtered.length;

            filtered.forEach(item => {
                const active = currentRecord && currentRecord.image_link === item.image_link ? 'active' : '';
                list.innerHTML += `
                    <div class="msg-item ${active}" onclick='openDetail(${JSON.stringify(item).replace(/'/g, "\\'")})'>
                        <img src="${item.avatar || '/static/avatars/1.png'}" class="avatar" onerror="this.src='/static/avatars/1.png'">
                        <div class="msg-info">
                            <div class="msg-name">${item.customer_name || 'Kh√¥ng t√™n'}</div>
                            <div class="msg-preview">
                                <span>${item.shoot_date || ''}</span>
                                <span class="msg-status">${item.label || 'M·ªõi'}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function openDetail(item) {
            currentRecord = item;
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('detail-view').style.display = 'flex';
            
            // Fill data
            document.getElementById('customer-name-header').textContent = item.customer_name || 'Kh√¥ng t√™n';
            document.getElementById('d_link_href').innerText = item.image_link || '';
            document.getElementById('d_link_href').href = item.image_link || '#';
            document.getElementById('d_note').value = item.note || '';
            document.getElementById('d_label').value = item.label || 'M·ªõi';
            document.getElementById('m_result_link').value = item.result_link || '';
            document.getElementById('m_result_msg').value = item.result_content || '';

            // Render chat messages
            renderChatMessages(item);

            // LOGIC MOBILE: Slide Effect
            if (window.innerWidth <= 768) {
                // Hi·ªán content, ·∫©n sidebar
                document.getElementById('detail-view-container').classList.add('open');
                document.querySelector('.sidebar').classList.add('hidden-on-mobile');
            }

            // C·∫≠p nh·∫≠t l·∫°i danh s√°ch v·ªõi b·ªô l·ªçc hi·ªán t·∫°i
            filterList(); 
        }

        function renderChatMessages(item) {
            const chatContainer = document.getElementById('chat-messages');
            chatContainer.innerHTML = '';
            
            // Original message from customer
            if (item.image_link) {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'message-bubble received-message';
                msgDiv.innerHTML = `
                    <div>Link ·∫£nh: <a href="${item.image_link}" target="_blank">${item.image_link}</a></div>
                    <div style="margin-top: 8px;">${item.note || ''}</div>
                    <div class="message-time">${item.created_at || ''}</div>
                `;
                chatContainer.appendChild(msgDiv);
            }
            
            // Result message from admin (if exists)
            if (item.result_link || item.result_content) {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'message-bubble sent-message';
                resultDiv.innerHTML = `
                    <div>K·∫øt qu·∫£: <a href="${item.result_link || '#'}" target="_blank">${item.result_link || 'Kh√¥ng c√≥ link'}</a></div>
                    <div style="margin-top: 8px;">${item.result_content || ''}</div>
                    <div class="message-time">ƒê√£ ho√†n th√†nh</div>
                `;
                chatContainer.appendChild(resultDiv);
            }
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function closeDetail() {
            // LOGIC MOBILE: Quay v·ªÅ danh s√°ch
            document.getElementById('detail-view-container').classList.remove('open');
            document.querySelector('.sidebar').classList.remove('hidden-on-mobile');
            
            // Reset state
            currentRecord = null;
            document.getElementById('detail-view').style.display = 'none';
            document.getElementById('empty-state').style.display = 'block';
        }

        function checkCompletion() {
            if (document.getElementById('d_label').value === 'Ho√†n th√†nh') {
                document.getElementById('completionModal').style.display = 'flex';
            }
        }

        function closeModal(id) { 
            document.getElementById(id).style.display = 'none'; 
        }

        async function confirmCompletion() {
            currentRecord.result_link = document.getElementById('m_result_link').value;
            currentRecord.result_content = document.getElementById('m_result_msg').value;
            closeModal('completionModal');
            saveChanges(); 
        }

        async function saveChanges() {
            if(!currentRecord) return;
            
            const payload = {
                image_link: currentRecord.image_link,
                customer_name: document.getElementById('customer-name-header').textContent,
                note: document.getElementById('d_note').value,
                label: document.getElementById('d_label').value,
                result_link: document.getElementById('m_result_link').value,
                result_content: document.getElementById('m_result_msg').value
            };
            
            try {
                const res = await fetch('/api/admin/update_ticket', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(payload)
                });
                
                if (res.ok) {
                    alert("ƒê√£ c·∫≠p nh·∫≠t!");
                    loadData(); // Reload data to reflect changes
                } else {
                    const errorData = await res.json();
                    alert("L·ªói c·∫≠p nh·∫≠t: " + (errorData.message || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th√¥ng tin"));
                }
            } catch (error) {
                console.error("Error saving changes:", error);
                alert("L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.");
            }
        }

        async function deleteCurrentTicket() {
            if (!currentRecord) return;
            const confirmDelete = confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a kh√°ch h√†ng: ${currentRecord.customer_name || 'Kh√¥ng t√™n'}?`);
            if (confirmDelete) {
                try {
                    const res = await fetch('/api/admin/delete_ticket', {
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({image_link: currentRecord.image_link})
                    });
                    const data = await res.json();
                    if (data.success) {
                        alert("ƒê√£ x√≥a xong!");
                        closeDetail(); // Quay v·ªÅ danh s√°ch
                        loadData();
                    } else {
                        alert("L·ªói: " + (data.message || "Kh√¥ng th·ªÉ x√≥a"));
                    }
                } catch (error) {
                    console.error("Error deleting ticket:", error);
                    alert("L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.");
                }
            }
        }

        function copyLink() {
            const link = document.getElementById('d_link_href').href;
            if (link && link !== '#') {
                navigator.clipboard.writeText(link).then(() => {
                    alert('ƒê√£ sao ch√©p link!');
                }).catch(err => {
                    console.error('Could not copy text: ', err);
                    // Fallback
                    const textArea = document.createElement("textarea");
                    textArea.value = link;
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        alert('ƒê√£ sao ch√©p link!');
                    } catch (err) {
                        alert('Kh√¥ng th·ªÉ sao ch√©p. Vui l√≤ng th·ª≠ l·∫°i.');
                    }
                    document.body.removeChild(textArea);
                });
            }
        }

        function openLabelMgr() {
            document.getElementById('labelMgrModal').style.display = 'flex';
            renderLabelList();
        }

        function renderLabelList() {
            const ul = document.getElementById('label-mgr-list');
            ul.innerHTML = allLabels.map(l => {
                const isPublic = PUBLIC_LABELS.includes(l);
                const delBtn = isPublic ? '' : `<span class="btn-del-label" onclick="manageLabelAPI('delete', '${l.replace(/'/g, "\\'")}')">X√≥a</span>`;
                return `<li style="padding:5px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">${l} ${delBtn}</li>`;
            }).join('');
        }

        async function manageLabelAPI(action, lblName = null) {
            const name = lblName || document.getElementById('new_label_input').value;
            if(!name) {
                alert('Vui l√≤ng nh·∫≠p t√™n Label!');
                return;
            }
            
            try {
                const res = await fetch('/api/admin/manage_label', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: action, label: name})
                });
                const d = await res.json();
                if(d.success) {
                    allLabels = d.labels || [];
                    renderLabelList();
                    renderUI();
                    if(action === 'add') document.getElementById('new_label_input').value = '';
                } else { 
                    alert(d.message || 'Kh√¥ng th·ªÉ th·ª±c hi·ªán thao t√°c'); 
                }
            } catch (error) {
                console.error("Error managing label:", error);
                alert("L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.");
            }
        }

        function openConfigModal() { 
            // Load current config values
            document.getElementById('configModal').style.display = 'flex'; 
        }

        async function saveConfig() {
            const bg = document.getElementById('cfg_bg').value;
            const txt = document.getElementById('cfg_text').value;
            const payload = {};
            if(bg) payload.bg_image = bg;
            if(txt) payload.text_color = txt;
            
            if (Object.keys(payload).length === 0) {
                alert('Vui l√≤ng thay ƒë·ªïi √≠t nh·∫•t m·ªôt t√πy ch·ªçn!');
                return;
            }
            
            try {
                const res = await fetch('/api/admin/update_config', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if(data.success) {
                    alert("ƒê√£ c·∫≠p nh·∫≠t giao di·ªán Client!");
                    closeModal('configModal');
                } else { 
                    alert("L·ªói: " + (data.message || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t")); 
                }
            } catch (error) {
                console.error("Error saving config:", error);
                alert("L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.");
            }
        }

        // Handle Enter key in login form
        document.addEventListener('DOMContentLoaded', function() {
            const loginOverlay = document.getElementById('login-overlay');
            if (loginOverlay) {
                const inputs = loginOverlay.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            login();
                        }
                    });
                });
            }
            
            // Check session on page load
            checkSession();
        });

        // --- CHECK SESSION (ƒê·∫∂T ·ªû CU·ªêI C√ôNG, NGO√ÄI C√ÅC H√ÄM KH√ÅC) ---
        function checkSession() {
            const token = localStorage.getItem("admin_token");
            if (token === "true") {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('dashboard').style.display = 'grid';
                loadData();
            }
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
